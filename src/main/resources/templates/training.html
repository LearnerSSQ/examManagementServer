<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>培训管理 - 考试管理系统</title>
    <link rel="stylesheet" th:href="@{/css/vscode.css}">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="vscode-titlebar">
        <span>考试管理系统 - 培训管理</span>
    </div>

    <div class="vscode-sidebar">
        <div class="sidebar-title">导航菜单</div>
        <div class="sidebar-item" data-href="/api/profile">
            <i class="fas fa-home" style="margin-right: 8px;"></i>个人信息
        </div>
        <div class="sidebar-item" data-href="/teachers">
            <i class="fas fa-chalkboard-teacher" style="margin-right: 8px;"></i>教师管理
        </div>
        <div class="sidebar-item" data-href="/invigilation">
            <i class="fas fa-tasks" style="margin-right: 8px;"></i>监考管理
        </div>
        <div class="sidebar-item active" data-href="/training">
            <i class="fas fa-graduation-cap" style="margin-right: 8px;"></i>培训管理
        </div>
        <div class="sidebar-title" style="margin-top: 20px;">用户</div>
        <div class="sidebar-item" data-href="/logout">
            <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>退出登录
        </div>
    </div>

    <div class="vscode-main">
        <div class="vscode-tabs">
            <div class="vscode-tab active" data-tab="materials">培训材料</div>
            <div class="vscode-tab" data-tab="records">培训记录</div>
        </div>

        <div id="materials-content" class="tab-content" style="padding: 20px;">
            <!-- 工具栏 -->
            <div class="editor-area" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="vscode-input" placeholder="搜索培训..." id="searchInput">
                    <select class="vscode-input" id="typeFilter">
                        <option value="">所有类型</option>
                        <option value="1">监考培训</option>
                        <option value="2">教学培训</option>
                        <option value="3">安全培训</option>
                    </select>
                    <button class="vscode-button" id="addMaterialBtn">
                        <i class="fas fa-plus"></i> 添加培训
                    </button>
                </div>
            </div>

            <!-- 培训材料列表 -->
            <div class="editor-area">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--vscode-sidebar-border);">
                            <th style="padding: 10px; text-align: left;">标题</th>
                            <th style="padding: 10px; text-align: left;">类型</th>
                            <th style="padding: 10px; text-align: left;">所需时长</th>
                            <th style="padding: 10px; text-align: left;">及格分数</th>
                            <th style="padding: 10px; text-align: left;">状态</th>
                            <th style="padding: 10px; text-align: left;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="materialList">
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="records-content" class="tab-content" style="display: none; padding: 20px;">
            <!-- 记录筛选 -->
            <div class="editor-area" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="vscode-input" placeholder="搜索培训..." id="recordSearchInput">
                    <select class="vscode-input" id="recordStatusFilter">
                        <option value="">所有状态</option>
                        <option value="0">未开始</option>
                        <option value="1">进行中</option>
                        <option value="2">已完成</option>
                        <option value="3">已过期</option>
                    </select>
                </div>
            </div>

            <!-- 培训记录列表 -->
            <div class="editor-area">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--vscode-sidebar-border);">
                            <th style="padding: 10px; text-align: left;">培训标题</th>
                            <th style="padding: 10px; text-align: left;">教师</th>
                            <th style="padding: 10px; text-align: left;">开始时间</th>
                            <th style="padding: 10px; text-align: left;">完成时间</th>
                            <th style="padding: 10px; text-align: left;">得分</th>
                            <th style="padding: 10px; text-align: left;">状态</th>
                            <th style="padding: 10px; text-align: left;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordList">
                        <tr>
                            <td colspan="7" style="padding: 20px; text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加/编辑培训对话框 -->
    <div id="materialDialog"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="editor-area"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px;">
            <h3 style="margin-top: 0;">添加培训</h3>
            <form id="materialForm" style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label for="title">标题</label>
                    <input type="text" id="title" class="vscode-input" style="width: 100%" required>
                </div>
                <div>
                    <label for="type">类型</label>
                    <select id="type" class="vscode-input" style="width: 100%" required>
                        <option value="1">监考培训</option>
                        <option value="2">教学培训</option>
                        <option value="3">安全培训</option>
                    </select>
                </div>
                <div>
                    <label for="requiredMinutes">所需时长（分钟）</label>
                    <input type="number" id="requiredMinutes" class="vscode-input" style="width: 100%" required min="1">
                </div>
                <div>
                    <label for="passingScore">及格分数</label>
                    <input type="number" id="passingScore" class="vscode-input" style="width: 100%" required min="0"
                        max="100">
                </div>
                <div>
                    <label for="content">培训内容</label>
                    <textarea id="content" class="vscode-input" style="width: 100%; height: 150px;" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="vscode-button" style="background-color: var(--vscode-sidebar-bg);"
                        onclick="closeDialog()">取消</button>
                    <button type="submit" class="vscode-button">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 查看培训记录对话框 -->
    <div id="recordDialog"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="editor-area"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px;">
            <h3 style="margin-top: 0;">培训记录详情</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label>培训标题</label>
                    <div id="recordTitle" class="vscode-input" style="width: 100%; padding: 5px;"></div>
                </div>
                <div>
                    <label>教师</label>
                    <div id="recordTeacher" class="vscode-input" style="width: 100%; padding: 5px;"></div>
                </div>
                <div>
                    <label>开始时间</label>
                    <div id="recordStartTime" class="vscode-input" style="width: 100%; padding: 5px;"></div>
                </div>
                <div>
                    <label>完成时间</label>
                    <div id="recordEndTime" class="vscode-input" style="width: 100%; padding: 5px;"></div>
                </div>
                <div>
                    <label>得分</label>
                    <div id="recordScore" class="vscode-input" style="width: 100%; padding: 5px;"></div>
                </div>
                <div>
                    <label>状态</label>
                    <div id="recordStatus" class="vscode-input" style="width: 100%; padding: 5px;"></div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="vscode-button" onclick="closeRecordDialog()">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <div class="vscode-statusbar">
        <span>共 <span id="materialCount">0</span> 个培训</span>
        <span style="margin-left: auto;">就绪</span>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script th:src="@{/js/auth.js}"></script>
    <script>
        $(document).ready(function () {
            // 从model中获取token
            const modelToken = /*[[${token}]]*/ null;
            if (modelToken) {
                localStorage.setItem('token', modelToken);
            }

            // 检查是否有token
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // 设置全局的AJAX请求头
            $.ajaxSetup({
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            // 加载培训材料
            loadMaterials();

            // 加载培训记录
            loadRecords();

            // 搜索和筛选
            $('#searchInput').on('input', debounce(loadMaterials, 500));
            $('#typeFilter').on('change', loadMaterials);
            $('#recordSearchInput').on('input', debounce(loadRecords, 500));
            $('#recordStatusFilter').on('change', loadRecords);

            // 添加培训按钮
            $('#addMaterialBtn').click(function () {
                $('#materialDialog h3').text('添加培训');
                $('#materialForm')[0].reset();
                $('#materialDialog').show();
            });

            // 表单提交
            $('#materialForm').on('submit', function (e) {
                e.preventDefault();
                saveMaterial();
            });

            // 标签页切换
            $('.vscode-tab').click(function () {
                $('.vscode-tab').removeClass('active');
                $(this).addClass('active');

                const tabId = $(this).data('tab');
                $('.tab-content').hide();
                $(`#${tabId}-content`).show();

                // 更新状态栏
                $('.vscode-statusbar span:last').text('正在查看' + $(this).text());

                // 如果切换到培训记录，重新加载数据
                if (tabId === 'records') {
                    loadRecords();
                }
            });
        });

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 加载培训材料
        function loadMaterials() {
            $('.vscode-statusbar span:last').text('正在加载数据...');
            const searchTerm = $('#searchInput').val();
            const type = $('#typeFilter').val();

            $.ajax({
                url: '/api/training/materials',
                method: 'GET',
                data: {
                    search: searchTerm,
                    type: type
                },
                success: function (response) {
                    if (response.code === 200) {
                        renderMaterials(response.data || []);
                        $('#materialCount').text(response.data.length);
                        $('.vscode-statusbar span:last').text('就绪');
                    } else {
                        $('.vscode-statusbar span:last').text('加载失败：' + response.message);
                    }
                },
                error: function () {
                    $('.vscode-statusbar span:last').text('加载失败');
                }
            });
        }

        // 渲染培训材料
        function renderMaterials(materials) {
            const tbody = $('#materialList').empty();

            if (materials.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center;">暂无数据</td>
                    </tr>
                `);
                return;
            }

            materials.forEach(material => {
                const tr = $('<tr>').css('border-bottom', '1px solid var(--vscode-sidebar-border)');
                tr.append($('<td>').text(material.title).css('padding', '10px'));
                tr.append($('<td>').text(getMaterialType(material.type)).css('padding', '10px'));
                tr.append($('<td>').text(material.requiredMinutes + '分钟').css('padding', '10px'));
                tr.append($('<td>').text(material.passingScore + '分').css('padding', '10px'));
                tr.append($('<td>').text(getMaterialStatus(material.status)).css('padding', '10px'));

                const actions = $('<td>').css('padding', '10px');
                actions.append(
                    $('<button>').addClass('vscode-button').css('margin-right', '5px')
                        .html('<i class="fas fa-edit"></i>')
                        .click(() => editMaterial(material))
                );
                actions.append(
                    $('<button>').addClass('vscode-button').css('background-color', '#d32f2f')
                        .html('<i class="fas fa-trash"></i>')
                        .click(() => deleteMaterial(material.materialId))
                );
                tr.append(actions);

                tbody.append(tr);
            });
        }

        // 加载培训记录
        function loadRecords() {
            $('.vscode-statusbar span:last').text('正在加载记录...');
            const searchTerm = $('#recordSearchInput').val();
            const status = $('#recordStatusFilter').val();

            $.ajax({
                url: '/api/training/records',
                method: 'GET',
                data: {
                    search: searchTerm,
                    status: status
                },
                success: function (response) {
                    if (response.code === 200) {
                        renderRecords(response.data || []);
                        $('.vscode-statusbar span:last').text('就绪');
                    } else {
                        $('.vscode-statusbar span:last').text('加载失败：' + response.message);
                    }
                },
                error: function () {
                    $('.vscode-statusbar span:last').text('加载失败');
                }
            });
        }

        // 渲染培训记录
        function renderRecords(records) {
            const tbody = $('#recordList').empty();

            if (records.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="7" style="padding: 20px; text-align: center;">暂无数据</td>
                    </tr>
                `);
                return;
            }

            records.forEach(record => {
                const tr = $('<tr>').css('border-bottom', '1px solid var(--vscode-sidebar-border)');
                tr.append($('<td>').text(record.title).css('padding', '10px'));
                tr.append($('<td>').text(record.teacherName).css('padding', '10px'));
                tr.append($('<td>').text(formatDateTime(record.startTime)).css('padding', '10px'));
                tr.append($('<td>').text(record.endTime ? formatDateTime(record.endTime) : '-').css('padding', '10px'));
                tr.append($('<td>').text(record.score !== null ? record.score + '分' : '-').css('padding', '10px'));
                tr.append($('<td>').text(getRecordStatus(record.status)).css('padding', '10px'));

                const actions = $('<td>').css('padding', '10px');
                actions.append(
                    $('<button>').addClass('vscode-button')
                        .html('<i class="fas fa-eye"></i>')
                        .click(() => viewRecord(record))
                );
                tr.append(actions);

                tbody.append(tr);
            });
        }

        // 获取培训类型文本
        function getMaterialType(type) {
            switch (type) {
                case 1: return '监考培训';
                case 2: return '教学培训';
                case 3: return '安全培训';
                default: return '未知';
            }
        }

        // 获取培训状态文本
        function getMaterialStatus(status) {
            switch (status) {
                case 0: return '未发布';
                case 1: return '已发布';
                case 2: return '已下架';
                default: return '未知';
            }
        }

        // 获取记录状态文本
        function getRecordStatus(status) {
            switch (status) {
                case 0: return '未开始';
                case 1: return '进行中';
                case 2: return '已完成';
                case 3: return '已过期';
                default: return '未知';
            }
        }

        // 格式化日期时间
        function formatDateTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleString();
        }

        // 保存培训材料
        function saveMaterial() {
            const materialData = {
                title: $('#title').val(),
                type: $('#type').val(),
                requiredMinutes: $('#requiredMinutes').val(),
                passingScore: $('#passingScore').val(),
                content: $('#content').val()
            };

            const materialId = $('#materialForm').data('materialId');
            const method = materialId ? 'PUT' : 'POST';
            const url = materialId ? `/api/training/materials/${materialId}` : '/api/training/materials';

            $('.vscode-statusbar span:last').text('正在保存...');

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(materialData),
                success: function (response) {
                    if (response.code === 0) {
                        closeDialog();
                        loadMaterials();
                        $('.vscode-statusbar span:last').text('保存成功');
                    } else {
                        $('.vscode-statusbar span:last').text('保存失败：' + response.message);
                    }
                },
                error: function () {
                    $('.vscode-statusbar span:last').text('保存失败');
                }
            });
        }

        // 编辑培训材料
        function editMaterial(material) {
            $('#materialDialog h3').text('编辑培训');
            $('#materialForm').data('materialId', material.materialId);
            $('#title').val(material.title);
            $('#type').val(material.type);
            $('#requiredMinutes').val(material.requiredMinutes);
            $('#passingScore').val(material.passingScore);
            $('#content').val(material.content);
            $('#materialDialog').show();
        }

        // 删除培训材料
        function deleteMaterial(materialId) {
            if (confirm('确定要删除这个培训吗？')) {
                $('.vscode-statusbar span:last').text('正在删除...');
                $.ajax({
                    url: `/api/training/materials/${materialId}`,
                    method: 'DELETE',
                    success: function (response) {
                        if (response.code === 0) {
                            loadMaterials();
                            $('.vscode-statusbar span:last').text('删除成功');
                        } else {
                            $('.vscode-statusbar span:last').text('删除失败：' + response.message);
                        }
                    },
                    error: function () {
                        $('.vscode-statusbar span:last').text('删除失败');
                    }
                });
            }
        }

        // 查看培训记录
        function viewRecord(record) {
            $('#recordTitle').text(record.title);
            $('#recordTeacher').text(record.teacherName);
            $('#recordStartTime').text(formatDateTime(record.startTime));
            $('#recordEndTime').text(record.endTime ? formatDateTime(record.endTime) : '-');
            $('#recordScore').text(record.score !== null ? record.score + '分' : '-');
            $('#recordStatus').text(getRecordStatus(record.status));
            $('#recordDialog').show();
        }

        // 关闭培训对话框
        function closeDialog() {
            $('#materialDialog').hide();
            $('#materialForm')[0].reset();
            $('#materialForm').removeData('materialId');
        }

        // 关闭记录对话框
        function closeRecordDialog() {
            $('#recordDialog').hide();
        }
    </script>
</body>

</html>