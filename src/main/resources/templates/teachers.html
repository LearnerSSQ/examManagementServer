<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>教师管理 - 考务管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/teachers.css}">
</head>

<body>
    <div class="background"></div>
    <div class="stars"></div>

    <!-- 引入导航栏 -->
    <div th:replace="fragments/nav :: nav"></div>

    <div class="main-content">
        <div class="page-header">
            <h1 class="gradient-text">教师管理</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="搜索教师...">
                    <button class="btn btn-primary" onclick="searchTeachers()">
                        <i class="fas fa-search"></i> 搜索
                    </button>
                </div>

                <!-- 只有系统管理员可见的添加教师按钮 -->
                <div sec:authorize="hasRole('ADMIN')">
                    <button class="btn btn-primary" onclick="showAddTeacherModal()">
                        <i class="fas fa-user-plus"></i> 添加教师
                    </button>
                </div>
            </div>
        </div>

        <div class="teachers-grid" id="teachersGrid">
            <!-- 教师卡片将通过JavaScript动态加载 -->
        </div>
    </div>

    <!-- 添加/编辑教师模态框 -->
    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 class="modal-title gradient-text" id="modalTitle">添加教师</h2>
            <form id="teacherForm">
                <input type="hidden" id="teacherId">
                <div class="form-group">
                    <label for="name">
                        <i class="fas fa-user"></i> 姓名
                    </label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i> 邮箱
                    </label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">
                        <i class="fas fa-phone"></i> 手机号
                    </label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="department">
                        <i class="fas fa-building"></i> 部门
                    </label>
                    <input type="text" id="department" required>
                </div>
                <div class="form-group">
                    <label for="title">
                        <i class="fas fa-graduation-cap"></i> 职称
                    </label>
                    <input type="text" id="title" required>
                </div>

                <!-- 只有系统管理员可以设置角色 -->
                <div class="form-group" sec:authorize="hasRole('ADMIN')">
                    <label for="role">
                        <i class="fas fa-user-tag"></i> 角色
                    </label>
                    <select id="role" required>
                        <option value="TEACHER">普通教师</option>
                        <option value="EXAM_ADMIN">考务管理员</option>
                        <option value="ADMIN">系统管理员</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="status">
                        <i class="fas fa-toggle-on"></i> 状态
                    </label>
                    <select id="status" required>
                        <option value="1">正常</option>
                        <option value="0">未激活</option>
                        <option value="2">已停用</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> 保存
                </button>
            </form>
        </div>
    </div>

    <script>
        // 加载教师列表
        function loadTeachers() {
            fetch('/api/teachers')
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('teachersGrid');
                    grid.innerHTML = '';

                    data.forEach(teacher => {
                        const card = createTeacherCard(teacher);
                        grid.appendChild(card);
                    });
                })
                .catch(error => console.error('Error loading teachers:', error));
        }

        // 创建教师卡片
        function createTeacherCard(teacher) {
            const card = document.createElement('div');
            card.className = 'teacher-card';

            const roleClass = `role-${teacher.role.toLowerCase()}`;

            card.innerHTML = `
                <div class="teacher-header">
                    <span class="teacher-name">${teacher.name}</span>
                    <span class="teacher-role ${roleClass}">${teacher.role}</span>
                </div>
                <div class="teacher-info">
                    <p><i class="fas fa-envelope"></i> ${teacher.email}</p>
                    <p><i class="fas fa-phone"></i> ${teacher.phone}</p>
                    <p><i class="fas fa-building"></i> ${teacher.department}</p>
                    <p><i class="fas fa-user-graduate"></i> ${teacher.title}</p>
                </div>
                <div class="teacher-actions">
                    ${createActionButtons(teacher)}
                </div>
            `;

            return card;
        }

        // 创建操作按钮
        function createActionButtons(teacher) {
            const isAdmin = document.querySelector('[sec:authorize="hasRole(\'ADMIN\')"]') !== null;
            const isExamAdmin = document.querySelector('[sec:authorize="hasRole(\'EXAM_ADMIN\')"]') !== null;

            let buttons = '';

            // 查看详情按钮对所有人可见
            buttons += `
                <button class="btn btn-primary" onclick="viewTeacher(${teacher.id})">
                    <i class="fas fa-eye"></i> 查看
                </button>
            `;

            // 编辑按钮只对管理员可见
            if (isAdmin) {
                buttons += `
                    <button class="btn btn-primary" onclick="editTeacher(${teacher.id})">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                `;
            }

            // 考务管理员可以查看监考记录
            if (isAdmin || isExamAdmin) {
                buttons += `
                    <button class="btn btn-primary" onclick="viewInvigilationHistory(${teacher.id})">
                        <i class="fas fa-history"></i> 监考记录
                    </button>
                `;
            }

            return buttons;
        }

        // 搜索教师
        function searchTeachers() {
            const searchTerm = document.querySelector('.search-input').value;
            fetch(`/api/teachers/search?term=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('teachersGrid');
                    grid.innerHTML = '';
                    data.forEach(teacher => {
                        const card = createTeacherCard(teacher);
                        grid.appendChild(card);
                    });
                })
                .catch(error => console.error('Error searching teachers:', error));
        }

        // 显示添加教师模态框
        function showAddTeacherModal() {
            document.getElementById('modalTitle').textContent = '添加教师';
            document.getElementById('teacherForm').reset();
            document.getElementById('teacherId').value = '';
            document.getElementById('teacherModal').style.display = 'block';
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('teacherModal').style.display = 'none';
        }

        // 编辑教师
        function editTeacher(id) {
            fetch(`/api/teachers/${id}`)
                .then(response => response.json())
                .then(teacher => {
                    document.getElementById('modalTitle').textContent = '编辑教师';
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('name').value = teacher.name;
                    document.getElementById('email').value = teacher.email;
                    document.getElementById('phone').value = teacher.phone;
                    document.getElementById('department').value = teacher.department;
                    document.getElementById('title').value = teacher.title;
                    document.getElementById('role').value = teacher.role;
                    document.getElementById('status').value = teacher.status;
                    document.getElementById('teacherModal').style.display = 'block';
                })
                .catch(error => console.error('Error loading teacher:', error));
        }

        // 查看教师详情
        function viewTeacher(id) {
            window.location.href = `/api/teachers/${id}`;
        }

        // 查看监考记录
        function viewInvigilationHistory(id) {
            window.location.href = `/api/teachers/${id}/invigilation-history`;
        }

        // 表单提交处理
        document.getElementById('teacherForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const teacherId = document.getElementById('teacherId').value;
            const method = teacherId ? 'PUT' : 'POST';
            const url = teacherId ? `/api/teachers/${teacherId}` : '/api/teachers';

            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                department: document.getElementById('department').value,
                title: document.getElementById('title').value,
                role: document.getElementById('role').value,
                status: parseInt(document.getElementById('status').value)
            };

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    closeModal();
                    loadTeachers();
                })
                .catch(error => console.error('Error saving teacher:', error));
        });

        // 页面加载时获取教师列表
        document.addEventListener('DOMContentLoaded', loadTeachers);
    </script>
</body>

</html>