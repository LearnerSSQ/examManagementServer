<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>监考安排 - 考务管理系统</title>
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/nav.css}">
    <link rel="stylesheet" th:href="@{/css/invigilation.css}">
</head>

<body>
    <div class="background"></div>
    <div class="stars"></div>

    <!-- 引入导航栏 -->
    <div th:replace="fragments/nav :: nav"></div>

    <div class="main-content">
        <div class="page-header">
            <h1 class="gradient-text">监考安排</h1>
            <div class="header-actions">
                <div class="filter-bar">
                    <select class="filter-select" onchange="filterInvigilations(this.value)">
                        <option value="all">全部监考</option>
                        <option value="pending">待确认</option>
                        <option value="confirmed">已确认</option>
                        <option value="completed">已完成</option>
                    </select>
                    <input type="date" class="date-filter" onchange="filterByDate(this.value)">
                </div>

                <!-- 考务管理员可见的添加按钮 -->
                <div sec:authorize="hasRole('EXAM_ADMIN')">
                    <button class="btn btn-primary" onclick="showAddInvigilationModal()">
                        <span>添加监考任务</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="invigilation-grid" id="invigilationGrid">
            <!-- 监考卡片将通过JavaScript动态加载 -->
        </div>
    </div>

    <!-- 添加/编辑监考模态框 -->
    <div id="invigilationModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 class="modal-title gradient-text" id="modalTitle">添加监考任务</h2>
            <form id="invigilationForm">
                <div class="form-group">
                    <label for="examName">考试名称</label>
                    <input type="text" id="examName" required>
                </div>
                <div class="form-group">
                    <label for="examDate">考试日期</label>
                    <input type="datetime-local" id="examDate" required>
                </div>
                <div class="form-group">
                    <label for="location">考试地点</label>
                    <input type="text" id="location" required>
                </div>
                <div class="form-group">
                    <label for="duration">考试时长（分钟）</label>
                    <input type="number" id="duration" required>
                </div>
                <div class="form-group">
                    <label for="teacherId">监考教师</label>
                    <select id="teacherId" required>
                        <!-- 教师列表将通过JavaScript动态加载 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="notes">备注</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span>保存</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // 加载监考列表
        function loadInvigilations() {
            fetch('/api/assignments/my')
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('invigilationGrid');
                    grid.innerHTML = '';
                    data.forEach(invigilation => {
                        const card = createInvigilationCard(invigilation);
                        grid.appendChild(card);
                    });
                })
                .catch(error => console.error('Error loading invigilations:', error));
        }

        // 创建监考卡片
        function createInvigilationCard(invigilation) {
            const card = document.createElement('div');
            card.className = 'invigilation-card';

            const statusClass = getStatusClass(invigilation.status);
            const formattedDate = formatDate(invigilation.examDate);

            card.innerHTML = `
                <div class="invigilation-header">
                    <span class="exam-name">${invigilation.examName}</span>
                    <span class="status-badge ${statusClass}">${invigilation.status}</span>
                </div>
                <div class="invigilation-info">
                    <p>考试时间：${formattedDate}</p>
                    <p>考试地点：${invigilation.location}</p>
                    <p>考试时长：${invigilation.duration}分钟</p>
                    <p>备注：${invigilation.notes || '无'}</p>
                </div>
                <div class="invigilation-actions">
                    ${createActionButtons(invigilation)}
                </div>
            `;

            return card;
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'PENDING': return 'status-pending';
                case 'CONFIRMED': return 'status-confirmed';
                case 'COMPLETED': return 'status-completed';
                default: return '';
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 创建操作按钮
        function createActionButtons(invigilation) {
            const isExamAdmin = document.querySelector('[sec:authorize="hasRole(\'EXAM_ADMIN\')"]') !== null;
            let buttons = '';

            if (invigilation.status === 'PENDING') {
                buttons += `
                    <button class="btn btn-primary" onclick="confirmInvigilation(${invigilation.id})">
                        <span>确认</span>
                    </button>
                    <button class="btn btn-secondary" onclick="rejectInvigilation(${invigilation.id})">
                        <span>拒绝</span>
                    </button>
                `;
            }

            if (isExamAdmin) {
                buttons += `
                    <button class="btn btn-primary" onclick="editInvigilation(${invigilation.id})">
                        <span>编辑</span>
                    </button>
                `;
            }

            return buttons;
        }

        // 确认监考
        function confirmInvigilation(id) {
            fetch(`/api/assignments/${id}/confirm`, { method: 'POST' })
                .then(response => response.json())
                .then(() => loadInvigilations())
                .catch(error => console.error('Error confirming invigilation:', error));
        }

        // 拒绝监考
        function rejectInvigilation(id) {
            fetch(`/api/assignments/${id}/reject`, { method: 'POST' })
                .then(response => response.json())
                .then(() => loadInvigilations())
                .catch(error => console.error('Error rejecting invigilation:', error));
        }

        // 显示添加监考模态框
        function showAddInvigilationModal() {
            document.getElementById('modalTitle').textContent = '添加监考任务';
            document.getElementById('invigilationForm').reset();
            document.getElementById('invigilationModal').style.display = 'block';
            loadTeachers();
        }

        // 加载教师列表
        function loadTeachers() {
            fetch('/api/teachers')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('teacherId');
                    select.innerHTML = '<option value="">请选择教师</option>';
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = `${teacher.name} (${teacher.department})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading teachers:', error));
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('invigilationModal').style.display = 'none';
        }

        // 表单提交处理
        document.getElementById('invigilationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = {
                examName: document.getElementById('examName').value,
                examDate: document.getElementById('examDate').value,
                location: document.getElementById('location').value,
                duration: parseInt(document.getElementById('duration').value),
                teacherId: parseInt(document.getElementById('teacherId').value),
                notes: document.getElementById('notes').value
            };

            fetch('/api/assignments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(() => {
                    closeModal();
                    loadInvigilations();
                })
                .catch(error => console.error('Error saving invigilation:', error));
        });

        // 页面加载时获取监考列表
        document.addEventListener('DOMContentLoaded', loadInvigilations);
    </script>
</body>

</html>